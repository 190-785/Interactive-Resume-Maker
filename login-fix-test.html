<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Login Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #17a2b8;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #218838; }
        .btn-primary { background: #007bff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .step {
            background: rgba(23, 162, 184, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #17a2b8;
        }
        .step h4 {
            margin: 0 0 10px 0;
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Complete Login Fix - Test & Repair Tool</h1>
        <p>This tool will help fix the login detection issue in Forest Drive and provide step-by-step testing.</p>

        <div class="test-section" id="current-status">
            <h3>üìä Current Status</h3>
            <div id="status-content">Checking...</div>
        </div>

        <div class="test-section">
            <h3>üîß Step-by-Step Fix Process</h3>
            
            <div class="step">
                <h4>Step 1: Verify Login Data</h4>
                <p>Check if you're properly logged in from the dashboard.</p>
                <button onclick="checkLoginData()">‚úÖ Check Login Data</button>
                <button class="btn-primary" onclick="openDashboard()">üìä Open Dashboard</button>
                <div id="login-check-result"></div>
            </div>

            <div class="step">
                <h4>Step 2: Test Cross-Domain Transfer</h4>
                <p>Test if login data transfers properly to the 3D scene domain.</p>
                <button onclick="testCrossDomain()">üîÑ Test Transfer</button>
                <button class="btn-warning" onclick="simulateTransfer()">üß™ Simulate Transfer</button>
                <div id="transfer-result"></div>
            </div>

            <div class="step">
                <h4>Step 3: Launch Forest Drive (Fixed)</h4>
                <p>Launch the 3D scene with the login fix applied.</p>
                <button onclick="launchForestDriveFixed()">üå≤ Launch Forest Drive (Fixed)</button>
                <button class="btn-primary" onclick="openForestDirect()">üöÄ Open Forest Direct</button>
                <div id="launch-result"></div>
            </div>

            <div class="step">
                <h4>Step 4: Verify Edit Functionality</h4>
                <p>Check if edit buttons are now enabled in the 3D scene.</p>
                <button onclick="showVerificationSteps()">üìã Show Verification Steps</button>
                <div id="verification-steps" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Emergency Fixes</h3>
            <button class="btn-warning" onclick="forceSyncLogin()">‚ö° Force Login Sync</button>
            <button class="btn-danger" onclick="resetAllData()">üóëÔ∏è Reset All Data</button>
            <button onclick="downloadFixedFiles()">üì• Download Fixed Files</button>
        </div>

        <div class="test-section">
            <h3>üì± Debug Information</h3>
            <button onclick="showDebugInfo()">üîç Show Debug Info</button>
            <button onclick="exportLogs()">üìÑ Export Logs</button>
            <div id="debug-info" style="display: none;">
                <pre id="debug-content"></pre>
            </div>
        </div>
    </div>

    <script>
        let debugLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push({ timestamp, message, type });
            console.log(`[${timestamp}] ${message}`);
        }

        function checkLoginData() {
            log('Checking login data...');
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const resultDiv = document.getElementById('login-check-result');
            
            let userData = null;
            try {
                if (user) userData = JSON.parse(user);
            } catch (e) {
                log('Error parsing user data: ' + e.message, 'error');
            }
            
            if (token && userData && (userData.username || userData.email || userData.fullName)) {
                resultDiv.innerHTML = `
                    <div style="color: #28a745; margin-top: 10px;">
                        ‚úÖ <strong>Login Data Valid</strong><br>
                        User: ${userData.username || userData.fullName || 'Unknown'}<br>
                        Token: ${token.substring(0, 15)}...<br>
                        Status: Ready for Forest Drive
                    </div>
                `;
                log('Login data validation successful', 'success');
                return true;
            } else {
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; margin-top: 10px;">
                        ‚ùå <strong>Login Data Invalid</strong><br>
                        Token: ${token ? 'Present' : 'Missing'}<br>
                        User Data: ${user ? 'Present but invalid' : 'Missing'}<br>
                        <strong>Action:</strong> Please log in through the dashboard first.
                    </div>
                `;
                log('Login data validation failed', 'error');
                return false;
            }
        }

        function testCrossDomain() {
            log('Testing cross-domain transfer...');
            
            const resultDiv = document.getElementById('transfer-result');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; margin-top: 10px;">
                        ‚ùå Cannot test transfer - no login data found.<br>
                        Please log in first.
                    </div>
                `;
                return;
            }
            
            // Create URL with login data
            const params = new URLSearchParams();
            params.append('token', token);
            params.append('user', user);
            const testUrl = 'http://localhost:3000?' + params.toString();
            
            resultDiv.innerHTML = `
                <div style="color: #28a745; margin-top: 10px;">
                    ‚úÖ <strong>Transfer URL Generated</strong><br>
                    URL Length: ${testUrl.length} characters<br>
                    Contains Token: ‚úÖ<br>
                    Contains User Data: ‚úÖ<br>
                    <button onclick="window.open('${testUrl}', '_blank')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">üå≤ Test in New Tab</button>
                </div>
            `;
            log('Cross-domain transfer test prepared', 'success');
        }

        function simulateTransfer() {
            log('Simulating login transfer...');
            
            // Simulate what the fixed dashboard would do
            const token = localStorage.getItem('token') || 'demo-token-' + Date.now();
            const userData = {
                username: 'testuser',
                fullName: 'Test User',
                email: 'test@example.com'
            };
            
            localStorage.setItem('token', token);
            localStorage.setItem('user', JSON.stringify(userData));
            localStorage.setItem('forestDriveMode', 'edit');
            
            const resultDiv = document.getElementById('transfer-result');
            resultDiv.innerHTML = `
                <div style="color: #ffc107; color: black; margin-top: 10px;">
                    ‚ö° <strong>Login Transfer Simulated</strong><br>
                    Created demo login data for testing.<br>
                    Now try launching Forest Drive.
                </div>
            `;
            log('Login transfer simulated successfully', 'success');
        }

        function launchForestDriveFixed() {
            log('Launching Forest Drive with login fix...');
            
            if (!checkLoginData()) {
                log('Cannot launch - invalid login data', 'error');
                return;
            }
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            // Set mode for edit functionality
            localStorage.setItem('forestDriveMode', 'edit');
            
            // Create URL with login parameters (the fix)
            const params = new URLSearchParams();
            params.append('token', token);
            params.append('user', user);
            const forestUrl = 'http://localhost:3000?' + params.toString();
            
            const resultDiv = document.getElementById('launch-result');
            resultDiv.innerHTML = `
                <div style="color: #28a745; margin-top: 10px;">
                    üöÄ <strong>Launching with Login Fix Applied</strong><br>
                    Opening Forest Drive with login data in URL...<br>
                    <em>Check the login status indicator in the top-right corner!</em>
                </div>
            `;
            
            log('Launching Forest Drive with login parameters', 'success');
            window.open(forestUrl, '_blank');
        }

        function openForestDirect() {
            window.open('http://localhost:3000', '_blank');
        }

        function openDashboard() {
            window.open('file:///F:/Interavtive_Resume/Interactive-Resume-Maker/FrontEnd/Login/dashboard.html', '_blank');
        }

        function showVerificationSteps() {
            const stepsDiv = document.getElementById('verification-steps');
            stepsDiv.style.display = stepsDiv.style.display === 'none' ? 'block' : 'none';
            
            stepsDiv.innerHTML = `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <h4>üîç Verification Checklist</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Check Login Status Indicator:</strong> Top-right corner should show "‚úÖ Logged in as [Your Name]"</li>
                        <li><strong>Drive to Any Scroll:</strong> Use arrow keys or WASD to drive the car</li>
                        <li><strong>Click on a Scroll:</strong> About, Skills, Experience, etc.</li>
                        <li><strong>Look for Edit Button:</strong> Should be enabled (not grayed out) at bottom of panel</li>
                        <li><strong>Test Edit Mode:</strong> Click "Edit" - should show text area and drag-drop zone</li>
                        <li><strong>Test Save:</strong> Make changes and click "Update Text" - should save to database</li>
                    </ol>
                    <p><strong>If any step fails:</strong> Use the emergency fixes below or check the debug information.</p>
                </div>
            `;
        }

        function forceSyncLogin() {
            log('Force syncing login data...');
            
            // Try to repair login data
            const token = localStorage.getItem('token');
            let user = localStorage.getItem('user');
            
            if (token && !user) {
                // Create minimal user data if token exists but user data is missing
                const minimalUser = {
                    username: 'user',
                    fullName: 'Resume User',
                    email: 'user@resume.com'
                };
                localStorage.setItem('user', JSON.stringify(minimalUser));
                user = JSON.stringify(minimalUser);
                log('Repaired missing user data', 'success');
            }
            
            if (token && user) {
                // Force save to all possible storage locations
                localStorage.setItem('resumeForestLogin', JSON.stringify({
                    token: token,
                    user: JSON.parse(user),
                    timestamp: Date.now()
                }));
                
                alert('‚úÖ Login data force-synced!\nNow try launching Forest Drive again.');
                log('Login data force-synced successfully', 'success');
            } else {
                alert('‚ùå No login data to sync.\nPlease log in through the dashboard first.');
                log('Force sync failed - no data to sync', 'error');
            }
        }

        function resetAllData() {
            if (confirm('‚ö†Ô∏è This will clear ALL data including login. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                log('All data reset', 'warning');
                alert('üóëÔ∏è All data cleared!\nYou will need to log in again.');
                location.reload();
            }
        }

        function downloadFixedFiles() {
            alert('üì• Fixed files are already in your project.\nKey files updated:\n- uiManager.js (login detection)\n- loginBridge.js (cross-domain fix)\n- dashboard.js (URL parameter passing)\n- index.html (script loading)');
        }

        function showDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
            
            const debugContent = document.getElementById('debug-content');
            const debugData = {
                timestamp: new Date().toISOString(),
                localStorage: {},
                url: window.location.href,
                userAgent: navigator.userAgent,
                logs: debugLogs
            };
            
            // Get all localStorage items
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                debugData.localStorage[key] = localStorage.getItem(key);
            }
            
            debugContent.textContent = JSON.stringify(debugData, null, 2);
        }

        function exportLogs() {
            const logData = {
                timestamp: new Date().toISOString(),
                logs: debugLogs,
                localStorage: Object.fromEntries(
                    Object.keys(localStorage).map(key => [key, localStorage.getItem(key)])
                )
            };
            
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `forest-drive-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Debug logs exported', 'success');
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status-content');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let userData = null;
            try {
                if (user) userData = JSON.parse(user);
            } catch (e) {}
            
            const isLoggedIn = !!(token && userData && (userData.username || userData.email || userData.fullName));
            
            if (isLoggedIn) {
                statusDiv.innerHTML = `
                    <div style="color: #28a745;">
                        ‚úÖ <strong>Ready to Fix</strong><br>
                        Login Status: Valid<br>
                        User: ${userData.username || userData.fullName}<br>
                        Next: Use "Launch Forest Drive (Fixed)" button
                    </div>
                `;
                document.getElementById('current-status').className = 'test-section success';
            } else {
                statusDiv.innerHTML = `
                    <div style="color: #dc3545;">
                        ‚ùå <strong>Login Required</strong><br>
                        Status: Not logged in<br>
                        Action: Log in through dashboard first<br>
                        Then return to this page
                    </div>
                `;
                document.getElementById('current-status').className = 'test-section error';
            }
        }

        // Initialize
        log('Login fix test tool initialized');
        updateStatus();
        
        // Auto-refresh status every 5 seconds
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>
